import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../features/admin/state/admin_state.dart';
import '../../services/world_admin_service.dart';

/// üéØ WELTSPEZIFISCHE USER-VERWALTUNG (EXAMPLE WIDGET)
/// 
/// Zeigt alle Code-Beispiele aus deiner Anfrage:
/// ‚úÖ Weltspezifische User-Liste
/// ‚úÖ Role-Badges (User/Admin/Root-Admin)
/// ‚úÖ Promote/Demote Actions (nur Root-Admin)
/// ‚úÖ Delete User (nur Root-Admin)
/// ‚úÖ Korrekte world-Parameter-√úbergabe
/// 
/// USAGE:
/// ```dart
/// WorldSpecificUserManagementWidget(world: 'materie')
/// WorldSpecificUserManagementWidget(world: 'energie')
/// ```

class WorldSpecificUserManagementWidget extends ConsumerStatefulWidget {
  final String world;
  
  const WorldSpecificUserManagementWidget({
    required this.world,
    super.key,
  });

  @override
  ConsumerState<WorldSpecificUserManagementWidget> createState() =>
      _WorldSpecificUserManagementWidgetState();
}

class _WorldSpecificUserManagementWidgetState
    extends ConsumerState<WorldSpecificUserManagementWidget> {
  List<WorldUser> _users = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadUsers();
  }

  /// Load weltspezifische User-Liste
  Future<void> _loadUsers() async {
    setState(() => _isLoading = true);
    
    try {
      // üî• WELTSPEZIFISCH: world korrekt √ºbergeben
      final users = await WorldAdminService.getUsersByWorld(widget.world);
      
      if (mounted) {
        setState(() {
          _users = users;
          _isLoading = false;
        });
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isLoading = false);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('‚ùå Fehler beim Laden der User: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  /// Promote User to Admin
  Future<void> _promoteUser(String username) async {
    // Find user by username
    final user = _users.firstWhere((u) => u.username == username);
    
    // Confirm
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('User zu Admin bef√∂rdern?'),
        content: Text('M√∂chtest du $username zu Admin bef√∂rdern?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Abbrechen'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            child: const Text('Bef√∂rdern'),
          ),
        ],
      ),
    );
    
    if (confirm != true) return;
    
    // Promote
    final success = await WorldAdminService.promoteUser(widget.world, user.userId);
    
    if (mounted) {
      if (success) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('‚úÖ $username wurde zu Admin bef√∂rdert'),
            backgroundColor: Colors.green,
          ),
        );
        await _loadUsers(); // Refresh
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('‚ùå Bef√∂rderung fehlgeschlagen'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  /// Demote Admin to User
  Future<void> _demoteUser(String username) async {
    final user = _users.firstWhere((u) => u.username == username);
    
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Admin-Rechte entfernen?'),
        content: Text('M√∂chtest du $username zum normalen User machen?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Abbrechen'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.orange),
            child: const Text('Degradieren'),
          ),
        ],
      ),
    );
    
    if (confirm != true) return;
    
    final success = await WorldAdminService.demoteUser(widget.world, user.userId);
    
    if (mounted) {
      if (success) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('‚úÖ $username wurde zu User degradiert'),
            backgroundColor: Colors.green,
          ),
        );
        await _loadUsers(); // Refresh
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('‚ùå Degradierung fehlgeschlagen'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  /// Delete User
  Future<void> _deleteUser(String username) async {
    final user = _users.firstWhere((u) => u.username == username);
    
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('‚ö†Ô∏è User l√∂schen?'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('M√∂chtest du $username wirklich l√∂schen?'),
            const SizedBox(height: 8),
            const Text(
              '‚ö†Ô∏è Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!',
              style: TextStyle(color: Colors.red, fontWeight: FontWeight.bold),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Abbrechen'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            child: const Text('L√∂schen'),
          ),
        ],
      ),
    );
    
    if (confirm != true) return;
    
    final success = await WorldAdminService.deleteUser(widget.world, user.userId);
    
    if (mounted) {
      if (success) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('‚úÖ $username wurde gel√∂scht'),
            backgroundColor: Colors.green,
          ),
        );
        await _loadUsers(); // Refresh
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('‚ùå L√∂schung fehlgeschlagen'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    // üî• RIVERPOD: Admin-Status aus State lesen
    final admin = ref.watch(adminStateProvider(widget.world));

    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }

    // üî• WELTSPEZIFISCH: Keine User in dieser Welt
    if (_users.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.people_outline, size: 64, color: Colors.grey),
            const SizedBox(height: 16),
            Text('Keine User in ${widget.world.toUpperCase()}'),
            const SizedBox(height: 8),
            ElevatedButton(
              onPressed: _loadUsers,
              child: const Text('Erneut laden'),
            ),
          ],
        ),
      );
    }

    // üî• USER-LISTE MIT WELTSPEZIFISCHEN ACTIONS
    return ListView.builder(
      itemCount: _users.length,
      itemBuilder: (context, index) {
        final user = _users[index];

        return Card(
          margin: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          child: ListTile(
            // üî• ROLE-BADGE
            leading: user.role != 'user'
                ? const Icon(Icons.shield, color: Colors.amber)
                : const Icon(Icons.person),
            
            // Username
            title: Text(user.username),
            
            // Role
            subtitle: Text('${user.role} ‚Ä¢ ${widget.world}'),
            
            // üî• ACTIONS (nur f√ºr Root-Admin)
            trailing: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                // üî• PROMOTE: Root-Admin kann User zu Admin machen
                if (admin.isRootAdmin && user.role == 'user')
                  IconButton(
                    icon: const Icon(Icons.arrow_upward, color: Colors.green),
                    onPressed: () => _promoteUser(user.username),
                    tooltip: 'Zum Admin bef√∂rdern',
                  ),
                
                // üî• DEMOTE: Root-Admin kann Admin zu User machen
                if (admin.isRootAdmin && user.role == 'admin')
                  IconButton(
                    icon: const Icon(Icons.arrow_downward, color: Colors.orange),
                    onPressed: () => _demoteUser(user.username),
                    tooltip: 'Admin-Rechte entfernen',
                  ),
                
                // üî• DELETE: Root-Admin kann User l√∂schen
                if (admin.isRootAdmin && user.username != admin.username)
                  IconButton(
                    icon: const Icon(Icons.delete, color: Colors.red),
                    onPressed: () => _deleteUser(user.username),
                    tooltip: 'User l√∂schen',
                  ),
              ],
            ),
          ),
        );
      },
    );
  }
}

/// üéØ EXAMPLE SCREEN - VERWENDUNG DES WIDGETS
/// 
/// Zeigt wie das Widget in einem Screen verwendet wird

class WorldUserManagementScreen extends ConsumerWidget {
  final String world;
  
  const WorldUserManagementScreen({
    required this.world,
    super.key,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final admin = ref.watch(adminStateProvider(world));
    
    return Scaffold(
      appBar: AppBar(
        title: Text('${world.toUpperCase()} User-Verwaltung'),
        actions: [
          // Root-Admin Badge
          if (admin.isRootAdmin)
            Padding(
              padding: const EdgeInsets.all(8.0),
              child: Chip(
                avatar: const Icon(Icons.shield, size: 16, color: Colors.amber),
                label: const Text('ROOT', style: TextStyle(fontSize: 12)),
                backgroundColor: Colors.amber.withOpacity(0.2),
              ),
            ),
        ],
      ),
      body: admin.isAdmin
          ? WorldSpecificUserManagementWidget(world: world)
          : const Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.lock, size: 64, color: Colors.red),
                  SizedBox(height: 16),
                  Text('Kein Admin-Zugriff'),
                  Text('Diese Seite ist nur f√ºr Admins.'),
                ],
              ),
            ),
    );
  }
}
