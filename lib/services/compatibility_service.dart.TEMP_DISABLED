import '../models/spirit_extended_models.dart';
import '../models/energie_profile.dart';
import 'storage_service.dart';
import 'numerology_service.dart';
import 'archetype_service.dart';

/// VORSCHLAG 6: ARCHETYP-KOMPATIBILITÃ„T & BEZIEHUNGS-ANALYSE
/// Analysiert die KompatibilitÃ¤t zwischen zwei Personen basierend auf:
/// - Lebenszahlen
/// - Archetypen
/// - Numerologische Harmonie
class CompatibilityService {
  final StorageService _storage = StorageService();
  final NumerologyService _numerology = NumerologyService();
  final ArchetypeService _archetypes = ArchetypeService();

  /// Analysiere KompatibilitÃ¤t zwischen User und Partner
  Future<CompatibilityAnalysis> analyzeCompatibility({
    required EnergieProfile userProfile,
    required PartnerProfile partner,
  }) async {
    // PrÃ¼fe ob bereits Analyse existiert
    final existing = _storage.getCompatibilityAnalysis(
      userProfile.username,
      partner.id,
    );
    
    if (existing != null && 
        DateTime.now().difference(existing.analyzedAt).inDays < 30) {
      return existing;
    }

    // Berechne User Numerologie
    final userLifePath = _numerology.calculateLifePathNumber(userProfile.birthDate);
    
    // Berechne KompatibilitÃ¤ts-Score
    final score = _calculateCompatibilityScore(
      userLifePath,
      partner.lifePathNumber,
    );

    // Generiere StÃ¤rken
    final strengths = _generateStrengths(
      userLifePath,
      partner.lifePathNumber,
      partner.archetype,
    );

    // Generiere Herausforderungen
    final challenges = _generateChallenges(
      userLifePath,
      partner.lifePathNumber,
    );

    // Generiere Kommunikations-Tipps
    final tips = _generateCommunicationTips(
      userLifePath,
      partner.lifePathNumber,
      partner.archetype,
    );

    final analysis = CompatibilityAnalysis(
      userId: userProfile.username,
      partnerId: partner.id,
      compatibilityScore: score,
      strengths: strengths,
      challenges: challenges,
      communicationTips: tips,
      analyzedAt: DateTime.now(),
    );

    await _storage.saveCompatibilityAnalysis(analysis);
    return analysis;
  }

  int _calculateCompatibilityScore(int userLifePath, int partnerLifePath) {
    // Basis-KompatibilitÃ¤t nach numerologischen Regeln
    final harmonicCombinations = {
      // Perfekte Harmonie
      '1-5': 95, '2-6': 95, '3-9': 95, '4-8': 95,
      
      // Sehr gut
      '1-3': 85, '2-4': 85, '5-7': 85, '6-9': 85,
      
      // Gut
      '1-2': 75, '3-6': 75, '4-7': 75, '5-8': 75,
      
      // Mittel
      '1-4': 65, '2-5': 65, '3-7': 65, '6-8': 65,
      
      // Herausfordernd
      '1-6': 55, '4-5': 55, '7-8': 55,
    };

    final key1 = '$userLifePath-$partnerLifePath';
    final key2 = '$partnerLifePath-$userLifePath';
    
    return harmonicCombinations[key1] ?? 
           harmonicCombinations[key2] ?? 
           70; // Default
  }

  List<String> _generateStrengths(
    int userLifePath,
    int partnerLifePath,
    Map<String, dynamic> partnerArchetype,
  ) {
    final strengths = <String>[];

    // Basierend auf Lebenszahlen
    if (userLifePath == partnerLifePath) {
      strengths.add('ğŸŒŸ Ihr versteht euch intuitiv - gleiche Lebenszahl schafft tiefes VerstÃ¤ndnis');
    }

    if ((userLifePath + partnerLifePath) % 2 == 0) {
      strengths.add('âš–ï¸ Ausgeglichene Energie-Balance zwischen euch beiden');
    }

    // Spezifische Kombinationen
    if ((userLifePath == 1 && partnerLifePath == 5) ||
        (userLifePath == 5 && partnerLifePath == 1)) {
      strengths.add('ğŸš€ Perfekte Balance zwischen FÃ¼hrung und Freiheit');
    }

    if ((userLifePath == 2 && partnerLifePath == 6) ||
        (userLifePath == 6 && partnerLifePath == 2)) {
      strengths.add('ğŸ’– AuÃŸergewÃ¶hnliche emotionale Harmonie und FÃ¼rsorge');
    }

    if ((userLifePath == 3 && partnerLifePath == 9) ||
        (userLifePath == 9 && partnerLifePath == 3)) {
      strengths.add('ğŸ¨ Kreative Synergie und spirituelle Verbindung');
    }

    // Archetyp-basierte StÃ¤rken
    final archetypeName = partnerArchetype['name'] as String? ?? '';
    if (archetypeName == 'Der Liebende') {
      strengths.add('â¤ï¸ Partner bringt tiefe emotionale Verbindung');
    }

    if (strengths.isEmpty) {
      strengths.add('ğŸŒˆ Ihr ergÃ¤nzt euch auf einzigartige Weise');
    }

    return strengths;
  }

  List<String> _generateChallenges(int userLifePath, int partnerLifePath) {
    final challenges = <String>[];

    // GegensÃ¤tzliche Energien
    if ((userLifePath == 1 && partnerLifePath == 6) ||
        (userLifePath == 6 && partnerLifePath == 1)) {
      challenges.add('âš¡ Spannungsfeld zwischen UnabhÃ¤ngigkeit und Bindung');
    }

    if ((userLifePath == 4 && partnerLifePath == 5) ||
        (userLifePath == 5 && partnerLifePath == 4)) {
      challenges.add('ğŸ”„ Unterschiedliche BedÃ¼rfnisse: StabilitÃ¤t vs. Freiheit');
    }

    if ((userLifePath == 7 && partnerLifePath == 8) ||
        (userLifePath == 8 && partnerLifePath == 7)) {
      challenges.add('ğŸ¤” Innere Welt trifft auf Ã¤uÃŸere Ambitionen');
    }

    // Allgemeine Herausforderungen
    if (userLifePath % 3 == 0 && partnerLifePath % 3 == 0) {
      challenges.add('ğŸŒŠ Beide starke PersÃ¶nlichkeiten - Kompromisse wichtig');
    }

    if (challenges.isEmpty) {
      challenges.add('ğŸ¯ Unterschiede als Wachstumschance nutzen');
    }

    return challenges;
  }

  List<String> _generateCommunicationTips(
    int userLifePath,
    int partnerLifePath,
    Map<String, dynamic> partnerArchetype,
  ) {
    final tips = <String>[];

    // Lebenszahl-spezifische Tipps
    if (partnerLifePath == 1) {
      tips.add('ğŸ’¬ Partner schÃ¤tzt Direktheit und klare Ansagen');
    } else if (partnerLifePath == 2) {
      tips.add('ğŸ’¬ Partner braucht emotionale Sicherheit und Geduld');
    } else if (partnerLifePath == 7) {
      tips.add('ğŸ’¬ Partner braucht Zeit fÃ¼r sich - respektiere die RÃ¼ckzugsphasen');
    }

    // Archetyp-basierte Tipps
    final archetypeName = partnerArchetype['name'] as String? ?? '';
    if (archetypeName == 'Der Weise') {
      tips.add('ğŸ§˜ Partner schÃ¤tzt tiefgrÃ¼ndige GesprÃ¤che und Stille');
    } else if (archetypeName == 'Der Krieger') {
      tips.add('âš”ï¸ Partner braucht klare Grenzen und Ehrlichkeit');
    }

    // Allgemeine Tipps
    tips.add('ğŸ¤ RegelmÃ¤ÃŸige Check-ins Ã¼ber GefÃ¼hle und BedÃ¼rfnisse');
    tips.add('ğŸŒŸ Akzeptiere Unterschiede als Bereicherung');

    return tips;
  }

  /// Erstelle Partner-Profil
  Future<PartnerProfile> createPartnerProfile({
    required String name,
    required DateTime birthDate,
  }) async {
    final id = DateTime.now().millisecondsSinceEpoch.toString();
    final lifePathNumber = _numerology.calculateLifePathNumber(birthDate);
    final archetype = _archetypes.calculatePrimaryArchetype(birthDate);

    final partner = PartnerProfile(
      id: id,
      name: name,
      birthDate: birthDate,
      lifePathNumber: lifePathNumber,
      archetype: archetype,
      createdAt: DateTime.now(),
    );

    await _storage.savePartnerProfile(partner);
    return partner;
  }
}
