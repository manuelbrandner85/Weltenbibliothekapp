/// üéôÔ∏è TELEGRAM VOICE SCREEN
/// Full-screen voice chat UI with user tiles

import 'package:flutter/material.dart';
import '../../services/simple_voice_controller.dart';
import '../../models/chat_models.dart';
import '../../widgets/speaking_indicator.dart'; // üéôÔ∏è Speaking Indicator
import '../../widgets/voice_participants_panel.dart'; // üìã Participants Panel
import '../../widgets/push_to_talk_button.dart'; // üé§ Push-to-Talk
import '../../services/audio_settings_service.dart'; // üîä Audio Settings
import '../../widgets/voice_audio_visualizer.dart'; // üéµ Audio Visualizer
import '../../widgets/voice_filters_panel.dart'; // üéõÔ∏è Voice Filters
import '../../widgets/hand_raise_button.dart'; // ‚úã Hand Raise
import '../../widgets/voice_recording_controls.dart'; // üìπ Recording
import '../../widgets/voice_keyboard_shortcuts.dart'; // ‚å®Ô∏è Shortcuts
import '../../widgets/voice_emoji_reactions.dart'; // üòä Emoji Reactions
import '../../services/voice_filters_service.dart';
import '../../services/voice_room_recording_service.dart';

class TelegramVoiceScreen extends StatefulWidget {
  const TelegramVoiceScreen({super.key});

  @override
  State<TelegramVoiceScreen> createState() => _TelegramVoiceScreenState();
}

class _TelegramVoiceScreenState extends State<TelegramVoiceScreen> {
  final SimpleVoiceController _voiceController = SimpleVoiceController();
  final VoiceFiltersService _filtersService = VoiceFiltersService();
  final List<VoiceEmojiReaction> _emojiReactions = [];

  @override
  void initState() {
    super.initState();
    
    // SimpleVoiceController handles participant notifications internally
    print('üéôÔ∏è [TelegramVoiceScreen] Initialized with SimpleVoiceController');
  }
  
  @override
  void dispose() {
    // SimpleVoiceController is a singleton, don't dispose
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFF1A1A2E),
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () {
            _voiceController.minimize();
            Navigator.of(context).pop();
          },
        ),
        title: ListenableBuilder(
          listenable: _voiceController,
          builder: (context, child) {
            return Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  _voiceController.currentRoomName ?? 'Voice Chat',
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.w600,
                  ),
                ),
                Text(
                  '${_voiceController.participantCount} participants',
                  style: TextStyle(
                    color: Colors.white.withOpacity(0.6),
                    fontSize: 12,
                  ),
                ),
              ],
            );
          },
        ),
        actions: [
          // üéõÔ∏è Voice Filters
          IconButton(
            icon: const Icon(Icons.tune, color: Colors.white),
            tooltip: 'Voice-Filter',
            onPressed: () {
              showModalBottomSheet(
                context: context,
                backgroundColor: Colors.transparent,
                isScrollControlled: true,
                builder: (context) => VoiceFiltersPanel(
                  filtersService: _filtersService,
                ),
              );
            },
          ),
          // üìπ Recording
          IconButton(
            icon: const Icon(Icons.fiber_manual_record, color: Colors.white),
            tooltip: 'Aufnahme',
            onPressed: () {
              // Show recording controls
            },
          ),
          // ‚ùì Shortcuts Help
          IconButton(
            icon: const Icon(Icons.keyboard, color: Colors.white),
            tooltip: 'Tastaturk√ºrzel',
            onPressed: () {
              showDialog(
                context: context,
                builder: (context) => const VoiceShortcutsHelpDialog(),
              );
            },
          ),
        ],
      ),
      body: VoiceKeyboardShortcuts(
        voiceController: _voiceController,
        onEmojiShortcut: _addEmojiReaction,
        child: SafeArea(
          child: Stack(
            children: [
              // Main Content - Participants Grid
              Column(
                children: [
                  // üéµ Audio Visualizer
                  ListenableBuilder(
                    listenable: _voiceController,
                    builder: (context, child) {
                      return Padding(
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        child: VoiceAudioVisualizer(
                          isActive: _voiceController.currentSpeakerId != null,
                          color: Colors.greenAccent,
                          height: 50,
                        ),
                      );
                    },
                  ),
                  
                  // üìπ Recording Controls
                  if (_voiceController.currentRoomId != null)
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 16),
                      child: VoiceRecordingControls(
                        roomId: _voiceController.currentRoomId!,
                      ),
                    ),
                  
                  const SizedBox(height: 16),
                  
                  Expanded(
                    child: ListenableBuilder(
                      listenable: _voiceController,
                      builder: (context, child) {
                        final participants = _voiceController.participants;

                        // ‚úÖ DEBUG LOGGING
                        if (mounted) {
                          debugPrint('üéôÔ∏è [VoiceScreen] Rendering participants: ${participants.length}');
                          for (var p in participants) {
                            debugPrint('   üë§ ${p.username} (${p.userId})');
                          }
                        }

                        if (participants.isEmpty) {
                          return const Center(
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(Icons.person_off, size: 64, color: Colors.white24),
                                SizedBox(height: 16),
                                Text(
                                  'No participants yet...',
                                  style: TextStyle(color: Colors.white54, fontSize: 16),
                                ),
                                SizedBox(height: 8),
                                Text(
                                  'Waiting for users to join...',
                                  style: TextStyle(color: Colors.white38, fontSize: 12),
                                ),
                              ],
                            ),
                          );
                      }

                      return GridView.builder(
                        padding: const EdgeInsets.all(16),
                        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                          crossAxisCount: 2,
                          crossAxisSpacing: 16,
                          mainAxisSpacing: 16,
                          childAspectRatio: 0.85,
                        ),
                        itemCount: participants.length,
                        itemBuilder: (context, index) {
                          return _buildParticipantTile(participants[index]);
                        },
                      );
                    },
                  ),
                ),
              ],
            ),

            // Bottom Controls
            Positioned(
              left: 0,
              right: 0,
              bottom: 0,
              child: Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: const Color(0xFF16213E),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.3),
                      blurRadius: 10,
                      offset: const Offset(0, -2),
                    ),
                  ],
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: [
                    // Mute Button
                    ListenableBuilder(
                      listenable: _voiceController,
                      builder: (context, child) {
                        final isMuted = _voiceController.isMuted;
                        return _buildControlButton(
                          icon: isMuted ? Icons.mic_off : Icons.mic,
                          label: isMuted ? 'Freischalten' : 'Stumm',
                          color: isMuted ? Colors.red : Colors.green,
                          onPressed: () => _voiceController.toggleMute(),
                        );
                      },
                    ),

                    // Leave Button
                    _buildControlButton(
                      icon: Icons.call_end,
                      label: 'Verlassen',
                      color: Colors.red,
                      onPressed: () async {
                        await _voiceController.leaveVoiceRoom();
                        if (mounted) {
                          Navigator.of(context).pop();
                        }
                      },
                    ),
                  ],
                ),
              ),
            ),
            
            // Push-to-Talk Button (center, if enabled)
            PushToTalkButton(voiceController: _voiceController),
            
            // üòä Emoji Reactions Overlay
            VoiceEmojiReactionsWidget(reactions: _emojiReactions),
            
            // ‚úã Hand Raise Button
            if (_voiceController.currentUserId != null)
              Positioned(
                left: 16,
                bottom: 180,
                child: HandRaiseButton(
                  voiceController: _voiceController,
                  userId: _voiceController.currentUserId!,
                ),
              ),
            
            // üòä Emoji Quick Button
            Positioned(
              left: 16,
              bottom: 100,
              child: FloatingActionButton(
                onPressed: () {
                  VoiceEmojiReactionPicker.show(context, _addEmojiReaction);
                },
                backgroundColor: Colors.purple,
                child: const Icon(Icons.emoji_emotions, color: Colors.white),
              ),
            ),
            
            // Floating Participants Button
            Positioned(
              right: 16,
              bottom: 100,
              child: FloatingActionButton(
                onPressed: () {
                  showModalBottomSheet(
                    context: context,
                    backgroundColor: Colors.transparent,
                    isScrollControlled: true,
                    builder: (context) => VoiceParticipantsPanel(
                      voiceController: _voiceController,
                    ),
                  );
                },
                backgroundColor: Colors.purple,
                child: ListenableBuilder(
                  listenable: _voiceController,
                  builder: (context, child) {
                    return Badge(
                      label: Text('${_voiceController.participantCount}'),
                      child: const Icon(Icons.people, color: Colors.white),
                    );
                  },
                ),
              ),
            ),
          ],
        ),
      ),
        ),
    );
  }

  /// üòä Add Emoji Reaction
  void _addEmojiReaction(String emoji) {
    if (mounted) {
      setState(() {
        _emojiReactions.add(VoiceEmojiReaction(
          emoji: emoji,
          userId: _voiceController.currentUserId ?? 'unknown',
          timestamp: DateTime.now(),
        ));
        
        // Auto-remove after 3 seconds
        Future.delayed(const Duration(seconds: 3), () {
          if (mounted) {
            setState(() {
              _emojiReactions.removeWhere(
                (r) => DateTime.now().difference(r.timestamp).inSeconds >= 3,
              );
            });
          }
        });
      });
    }
  }

  Widget _buildParticipantTile(VoiceParticipant participant) {
    final isSpeaking = _voiceController.currentSpeakerId == participant.userId;
    final isCurrentUser = participant.userId == _voiceController.currentUserId;

    return Container(
      decoration: BoxDecoration(
        color: const Color(0xFF16213E),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: isSpeaking
              ? Colors.green
              : Colors.transparent,
          width: 3,
        ),
        boxShadow: isSpeaking
            ? [
                BoxShadow(
                  color: Colors.green.withOpacity(0.4),
                  blurRadius: 12,
                  spreadRadius: 2,
                ),
              ]
            : [],
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          // Avatar with pulsing ring when speaking
          Stack(
            alignment: Alignment.center,
            children: [
              // Pulsing ring
              if (isSpeaking)
                TweenAnimationBuilder<double>(
                  tween: Tween(begin: 0.8, end: 1.2),
                  duration: const Duration(milliseconds: 600),
                  curve: Curves.easeInOut,
                  builder: (context, value, child) {
                    return Transform.scale(
                      scale: value,
                      child: Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: Colors.green.withOpacity(0.5),
                            width: 3,
                          ),
                        ),
                      ),
                    );
                  },
                  onEnd: () {
                    // Restart animation
                    if (mounted) setState(() {});
                  },
                ),

              // Avatar
              Container(
                width: 64,
                height: 64,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      _getColorForUser(participant.userId),
                      _getColorForUser(participant.userId).withOpacity(0.6),
                    ],
                  ),
                ),
                child: Center(
                  child: Text(
                    participant.username[0].toUpperCase(),
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),

              // Mute indicator
              if (participant.isMuted)
                Positioned(
                  bottom: 0,
                  right: 0,
                  child: Container(
                    padding: const EdgeInsets.all(4),
                    decoration: const BoxDecoration(
                      color: Colors.red,
                      shape: BoxShape.circle,
                    ),
                    child: const Icon(
                      Icons.mic_off,
                      size: 16,
                      color: Colors.white,
                    ),
                  ),
                ),
            ],
          ),

          const SizedBox(height: 12),

          // Username
          Text(
            participant.username,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 14,
              fontWeight: FontWeight.w600,
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),

          // You indicator
          if (isCurrentUser)
            Text(
              '(You)',
              style: TextStyle(
                color: Colors.white.withOpacity(0.6),
                fontSize: 12,
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildControlButton({
    required IconData icon,
    required String label,
    required Color color,
    required VoidCallback onPressed,
  }) {
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        Material(
          color: color.withOpacity(0.2),
          shape: const CircleBorder(),
          child: InkWell(
            onTap: onPressed,
            customBorder: const CircleBorder(),
            child: Container(
              width: 64,
              height: 64,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                border: Border.all(
                  color: color.withOpacity(0.3),
                  width: 2,
                ),
              ),
              child: Icon(icon, color: color, size: 28),
            ),
          ),
        ),
        const SizedBox(height: 8),
        Text(
          label,
          style: TextStyle(
            color: color,
            fontSize: 12,
            fontWeight: FontWeight.w600,
          ),
        ),
      ],
    );
  }

  Color _getColorForUser(String userId) {
    final colors = [
      const Color(0xFF6A5ACD), // Slate Blue
      const Color(0xFFFF6B6B), // Red
      const Color(0xFF4ECDC4), // Turquoise
      const Color(0xFFFFD93D), // Yellow
      const Color(0xFF95E1D3), // Mint
      const Color(0xFFF38181), // Pink
      const Color(0xFF6C5CE7), // Purple
      const Color(0xFF00B894), // Green
    ];

    final hash = userId.hashCode.abs();
    return colors[hash % colors.length];
  }
}
